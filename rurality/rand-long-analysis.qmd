# Prerequisites
```{r}
#| label: load libraries
library(tidyverse)
library(haven)
library(survey)
library(srvyr)
```

# Data Compilation
```{r}
#| label: load the RAND Longitudinal File
rlf <- readRDS('/Users/tim/projects/rural-estate-law/data/hrs/rand-long-file.rds')
```

```{r}
# 
rlf_dd <- rlf %>%
    select( # select and rename
        RESP_ID = HHIDPN, SPOUSE_ID = S15HHIDPN, INW15, 
        STRATUM = RAESTRAT, SECU = RAEHSAMP, WGHT_R = R15WTRESP, WGHT_H = R15WTHH, 
        AGE = R15AGEY_E, GENDER = RAGENDER, RACE = RARACEM, HISP = RAHISPAN, EDUC_YRS = RAEDYRS,
        REGION = R15CENREG, RURAL = R15URBRUR,  
        HLTH_CHNG = R15HLTC3, WEALTH = H15ATOTB, OWN_HOME = H15ARLES,
    ) %>%
    filter(INW15 == '1') %>% select(-INW15) %>% # is in wave 15 (responded to survey. N = 15723)
    mutate( # semantic recodes
        # anything not matches -> NA by default 
        across(GENDER, ~case_match(.x, 
            1 ~ 'Male', 
            2 ~ 'Female')), 
        across(RACE, ~case_match(.x, 
            1 ~ 'White', 
            2 ~ 'Black', 
            3 ~ 'Other')), 
        across(HISP, ~case_match(.x, 
            0 ~ 'Not Hispanic', 
            1 ~ 'Hispanic')), 
        across(REGION, ~case_match(.x, 
            1 ~ 'Northeast', 
            2 ~ 'Midwest', 
            3 ~ 'South', 
            4 ~ 'West', 
            5 ~ 'Other')), 
        across(RURAL, ~case_match(.x, 
            1 ~ 'Urban', 
            2 ~ 'Suburban', 
            3 ~ 'Rural')), 
        across(HLTH_CHNG, ~case_match(.x, 
            1 ~ 'Better', 
            2 ~ 'Same', 
            3 ~ 'Worse')), 
        across(WEALTH, round), # round wealth to nearest dollar
    ) %>%
    mutate( # type conversions
        across(c(RESP_ID, SPOUSE_ID), as.character),     
        across(c(WGHT_R, WGHT_H, AGE, EDUC_YRS), as.integer), # convert to integer
        across(c(STRATUM, SECU, GENDER:RURAL), as_factor), # convert to factor
        across(SPOUSE_ID, ~na_if(.x, '0')) # NAs for respondants with no spouse
    ) 
rm(rlf)
```

```{r}
#| label: load the Wills data
wil <- read_sas('data/hrs/core-2020/h20t_r.sas7bdat') %>%
    select(HHID, PN, WILL_TYPE=RT001) %>%
    mutate(
        RESP_ID = paste0(HHID, PN),
        # across(WILL_TYPE, ~ifelse(.x %in% c('-8', '8', '9'), NA, .x)),
        across(WILL_TYPE, ~case_match(.x, 
            1 ~ 'Will', 
            2 ~ 'Both', 
            3 ~ 'Trust', 
            5 ~ 'Neither', 
            # .default = NA_character_
            )),
        across(WILL_TYPE, as.factor),
        WILL_IND = fct_collapse(WILL_TYPE, 
            Y = c('Will', 'Both', 'Trust'), 
            N = c('Neither')), 
        across(WILL_IND, ~fct_relevel(as_factor(.x), 'N', 'Y'))
        ) %>%
    select(RESP_ID, WILL_TYPE, WILL_IND) 
 ```

```{r}
#merge
dd <- rlf_dd %>%
    left_join(wil, by='RESP_ID')
saveRDS(dd, '/Users/tim/projects/rural-estate-law/data/hrs/rand-long-file-merged.rds')
```

```{r}
#| label: load the home ownership data
hom <- read_sas('data/hrs/core-2020/h20h_h.sas7bdat') %>%
    select(
        HHID, RSUBHH, own_home=RH004,
    ) %>% # only the 2020 survey
    mutate(OWNHOME_IND = ifelse(OWN_HOME == '1', 'Y', 'N')) %>%
    mutate(
        across(OWNHOME_IND, ~fct_relevel(as_factor(.x), "N", "Y")),
        # across(HOME_VAL, as.numeric)
        ) %>%
    filter(
        OWN_HOME %in% 1:7, # excluding don't know, refused, and missing
        # between(HOME_VAL, 0, 3000000000) 
    ) %>%
    drop_na() 
```

# Exploratory Data Analysis

```{r}
#| label: load the merged data
dd <- readRDS('/Users/tim/projects/rural-estate-law/data/hrs/rand-long-file-merged.rds') 
```


```{r}
#| label: summary statistics
dd_srvy <- as_survey(dd, strata = STRATUM, weights = WGHT_R)
dd_srvy %>%
    group_by(WILL_IND) %>%
    summarize(will_prop = survey_prop())
dd_srvy2 <- as_survey(dd, strata = STRATUM, weights = WGHT_R, id = SECU, nest = TRUE)
dd_srvy2 %>%
    group_by(WILL_IND) %>%
    summarize(will_prop = survey_prop())
```